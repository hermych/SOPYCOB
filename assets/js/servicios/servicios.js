let español = {
  aria: {
    sortAscending: "Activar para ordenar la columna de manera ascendente",
    sortDescending: "Activar para ordenar la columna de manera descendente",
  },
  autoFill: {
    cancel: "Cancelar",
    fill: "Rellene todas las celdas con <i>%d</i>",
    fillHorizontal: "Rellenar celdas horizontalmente",
    fillVertical: "Rellenar celdas verticalmente",
  },
  buttons: {
    collection: "Colección",
    colvis: "Visibilidad",
    colvisRestore: "Restaurar visibilidad",
    copy: "Copiar",
    copyKeys:
      "Presione ctrl o u2318 + C para copiar los datos de la tabla al portapapeles del sistema. <br /> <br /> Para cancelar, haga clic en este mensaje o presione escape.",
    copySuccess: {
      1: "Copiada 1 fila al portapapeles",
      _: "Copiadas %d fila al portapapeles",
    },
    copyTitle: "Copiar al portapapeles",
    csv: "CSV",
    excel: "Excel",
    pageLength: {
      "-1": "Mostrar todas las filas",
      _: "Mostrar %d filas",
    },
    pdf: "PDF",
    print: "Imprimir",
    createState: "Crear Estado",
    removeAllStates: "Borrar Todos los Estados",
    removeState: "Borrar Estado",
    renameState: "Renombrar Estado",
    savedStates: "Guardar Estado",
    stateRestore: "Restaurar Estado",
    updateState: "Actualizar Estado",
  },
  infoThousands: ",",
  loadingRecords: "Cargando...",
  paginate: {
    first: "Primero",
    last: "Último",
    next: "Siguiente",
    previous: "Anterior",
  },
  processing: "Procesando...",
  search: "Buscar:",
  searchBuilder: {
    add: "Añadir condición",
    button: {
      0: "Constructor de búsqueda",
      _: "Constructor de búsqueda (%d)",
    },
    clearAll: "Borrar todo",
    condition: "Condición",
    deleteTitle: "Eliminar regla de filtrado",
    leftTitle: "Criterios anulados",
    logicAnd: "Y",
    logicOr: "O",
    rightTitle: "Criterios de sangría",
    title: {
      0: "Constructor de búsqueda",
      _: "Constructor de búsqueda (%d)",
    },
    value: "Valor",
    conditions: {
      date: {
        after: "Después",
        before: "Antes",
        between: "Entre",
        empty: "Vacío",
        equals: "Igual a",
        not: "Diferente de",
        notBetween: "No entre",
        notEmpty: "No vacío",
      },
      number: {
        between: "Entre",
        empty: "Vacío",
        equals: "Igual a",
        gt: "Mayor a",
        gte: "Mayor o igual a",
        lt: "Menor que",
        lte: "Menor o igual a",
        not: "Diferente de",
        notBetween: "No entre",
        notEmpty: "No vacío",
      },
      string: {
        contains: "Contiene",
        empty: "Vacío",
        endsWith: "Termina con",
        equals: "Igual a",
        not: "Diferente de",
        startsWith: "Inicia con",
        notEmpty: "No vacío",
        notContains: "No Contiene",
        notEnds: "No Termina",
        notStarts: "No Comienza",
      },
      array: {
        equals: "Igual a",
        empty: "Vacío",
        contains: "Contiene",
        not: "Diferente",
        notEmpty: "No vacío",
        without: "Sin",
      },
    },
    data: "Datos",
  },
  searchPanes: {
    clearMessage: "Borrar todo",
    collapse: {
      0: "Paneles de búsqueda",
      _: "Paneles de búsqueda (%d)",
    },
    count: "{total}",
    emptyPanes: "Sin paneles de búsqueda",
    loadMessage: "Cargando paneles de búsqueda",
    title: "Filtros Activos - %d",
    countFiltered: "{shown} ({total})",
    collapseMessage: "Colapsar",
    showMessage: "Mostrar Todo",
  },
  select: {
    cells: {
      1: "1 celda seleccionada",
      _: "%d celdas seleccionadas",
    },
    columns: {
      1: "1 columna seleccionada",
      _: "%d columnas seleccionadas",
    },
  },
  thousands: ",",
  datetime: {
    previous: "Anterior",
    hours: "Horas",
    minutes: "Minutos",
    seconds: "Segundos",
    unknown: "-",
    amPm: ["am", "pm"],
    next: "Siguiente",
    months: {
      0: "Enero",
      1: "Febrero",
      10: "Noviembre",
      11: "Diciembre",
      2: "Marzo",
      3: "Abril",
      4: "Mayo",
      5: "Junio",
      6: "Julio",
      7: "Agosto",
      8: "Septiembre",
      9: "Octubre",
    },
    weekdays: [
      "Domingo",
      "Lunes",
      "Martes",
      "Miércoles",
      "Jueves",
      "Viernes",
      "Sábado",
    ],
  },
  editor: {
    close: "Cerrar",
    create: {
      button: "Nuevo",
      title: "Crear Nuevo Registro",
      submit: "Crear",
    },
    edit: {
      button: "Editar",
      title: "Editar Registro",
      submit: "Actualizar",
    },
    remove: {
      button: "Eliminar",
      title: "Eliminar Registro",
      submit: "Eliminar",
      confirm: {
        _: "¿Está seguro que desea eliminar %d filas?",
        1: "¿Está seguro que desea eliminar 1 fila?",
      },
    },
    multi: {
      title: "Múltiples Valores",
      restore: "Deshacer Cambios",
      noMulti:
        "Este registro puede ser editado individualmente, pero no como parte de un grupo.",
      info: "Los elementos seleccionados contienen diferentes valores para este registro. Para editar y establecer todos los elementos de este registro con el mismo valor, haga click o toque aquí, de lo contrario conservarán sus valores individuales.",
    },
    error: {
      system:
        'Ha ocurrido un error en el sistema (<a target="\\" rel="\\ nofollow" href="\\"> Más información</a>).',
    },
  },
  decimal: ".",
  emptyTable: "No hay datos disponibles en la tabla",
  zeroRecords: "No se encontraron coincidencias",
  info: "Mostrando _START_ a _END_ de _TOTAL_ entradas",
  infoEmpty: "Mostrando 0 a 0 de 0 entradas",
  infoFiltered: "(Filtrado de _MAX_ total de entradas)",
  lengthMenu: "Mostrar _MENU_ entradas",
  stateRestore: {
    removeTitle: "Eliminar",
    creationModal: {
      search: "Busccar",
    },
  },
};
// ############# METODOS METODOS #############
function validarDatos(datos) {
  respuesta = {};
  datos.forEach((dato) => {
    if (dato.value == "" || dato.value == "0") {
      respuesta[dato.name] = `El campo ${dato.name} es obligatorio`;
    }
  });
  return respuesta;
}
function validarInputSoloNumeros(evt) {
  let code = (evt.which) ? evt.which : evt.keyCode;
  if (code == 8) { // backspace.
    return true;
  } else if (code >= 48 && code <= 57 || code == 46) { // is a number.
    return true;
  } else { // other keys.
    return false;
  }
}
function pintarProvCate(datos) {
  let proveedorServicio = document.getElementById("proveedorServicio");
  let categoriaServicio = document.getElementById("categoriaServicio");
  contenidoProv = "<option value='0' selected>Seleccione Proveedor</option>";
  contenidoCate = "<option value='0' selected>Seleccione Categoria</option>";
  let categorias = datos['cat']
  let proveedores = datos['prov']
  for (let i = 0; i < proveedores.length; i++) {
    contenidoProv += `<option value=${proveedores[i]['id']}>${proveedores[i]['nombre']}</option>`;
  }
  for (let i = 0; i < categorias.length; i++) {
    contenidoCate += `<option value=${categorias[i]['id']}>${categorias[i]['nombre']}</option>`;
  }
  proveedorServicio.innerHTML = contenidoProv;
  categoriaServicio.innerHTML = contenidoCate;
}
// ############# ABRIENDO MODALES ##############
$("#btnAbrirModalGuardarServicio").click(() => {
  let nombreServicio = document.getElementById("nombreServicio");
  let codServicio = document.getElementById("codServicio");
  let precioServicio = document.getElementById("precioServicio");
  let proveedorServicio = document.getElementById("proveedorServicio");
  let categoriaServicio = document.getElementById("categoriaServicio");
  datosArray = [
    nombreServicio, codServicio, precioServicio, proveedorServicio, categoriaServicio
  ];
  window.$.ajax({
    type: "GET",
    url: "ServiciosController.php?method=listarProveedoresCategoria",
    success: function (response) {
      let data = JSON.parse(response);
      pintarProvCate(data);
    },
  });
  setInterval(() => {
    let respuesta = validarDatos(datosArray);
    if (Object.keys(respuesta).length == 0) {
      $("#btnGuardarServicio").prop("disabled", false);
    } else {
      $("#btnGuardarServicio").prop("disabled", true);
    }
  }, 200);
});
$('#tbody').on("click", '#btnAbriModalEditarProveedor', function () {
  let nombreServicio = document.getElementById("editNombreServicio");
  let codServicio = document.getElementById("editCodServicio");
  let precioServicio = document.getElementById("editPrecioServicio");
  let proveedorServicio = document.getElementById("editProveedorServicio");
  let categoriaServicio = document.getElementById("editCategoriaServicio");
  datosArray = [
    nombreServicio, codServicio, precioServicio, proveedorServicio, categoriaServicio
  ];
  setInterval(() => {
    let respuesta = validarDatos(datosArray);
    if (Object.keys(respuesta).length == 0) {
      $("#btnEditarServicio").prop("disabled", false);
    } else {
      $("#btnEditarServicio").prop("disabled", true);
    }
  }, 200);
});
// ######## LLENAR DATA TABLE ############
$(document).ready(function () {
  let dataTable = $("#serviciosDataTable").DataTable({
    ajax: {
      url: "../controllers/ServiciosController.php?method=listarServiciosGlobal",
      method: "GET",
    },
    columns: [
      { data: "indice" },
      { data: "codInterno" },
      { data: "nombreServicio" },
      { data: "precio" },
      { data: "proveedor" },
      { data: "categoria" },
      { data: "estado",
        render: function(data, type, row){
          if(row.estado == 'activo'){
            return `<span class="badge bg-success">Activo</span>`
          }else{
            return `<span class="badge bg-danger">Inactivo</span>`
          }
        }
     },
      {
        data: "estado",
        render: function (data, type, row) {
          if (row.estado == 'activo') {
            return `<button type="button" id="btnAbriModalEditarProveedor" class="editar btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modalEditarServicio"><i class="fas fa-edit"></i></button>
                <button type="button" id="btnAbrirModelInhabilitarServicio" class="inhabilitar btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalInhabilitarServicio"><i class="fas fa-trash-alt" aria-hidden="true"></i></button>`;
          }
          if (row.estado == 'inhabilitado') {
            return `<button type="button" id="btnAbriModalEditarProveedor" class="editar btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modalEditarServicio"><i class="fas fa-edit"></i></button>
              <button type="button" id="btnAbrirModelHabilitarServicio" class="habilitar btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalHabilitarServicio"><i class="fas fa-check-circle"></i></i></button>`;
          }
        }
      },
    ],
    language: español,
  });
  // Modal Editar con datos correspondientes
  $('#serviciosDataTable tbody').on("click", ".editar", function () {
    let data = dataTable.row($(this).parents()).data();
    window.$.ajax({
      type: "GET",
      url: "ServiciosController.php?method=listarProveedoresCategoria",
      success: function (response) {
        let datos = JSON.parse(response);
        let proveedorServicio = document.getElementById("editProveedorServicio");
        let categoriaServicio = document.getElementById("editCategoriaServicio");
        contenidoProv = "<option value='0'>Seleccione Proveedor</option>";
        contenidoCate = "<option value='0'>Seleccione Categoria</option>";
        let categorias = datos['cat']
        let proveedores = datos['prov']
        for (let i = 0; i < proveedores.length; i++) {
          contenidoProv += `<option value=${proveedores[i]['id']}>${proveedores[i]['nombre']}</option>`;
        }
        for (let i = 0; i < categorias.length; i++) {
          contenidoCate += `<option value=${categorias[i]['id']}>${categorias[i]['nombre']}</option>`;
        }
        proveedorServicio.innerHTML = contenidoProv;
        categoriaServicio.innerHTML = contenidoCate;

        $('#editProveedorServicio').val(data.idProveedor);
        $('#editCategoriaServicio').val(data.idCategoria);
      },
    });
    $('#editNombreServicio').val(data.nombreServicio);
    $('#editCodServicio').val(data.codInterno);
    $('#editPrecioServicio').val(data.precio);
    $('#idServicio').val(data.idServicio);
  });
  // Modal Inhabilitar Proveedor con datos correspondientes
  $('#serviciosDataTable tbody').on("click", ".inhabilitar", function () {
    let data = dataTable.row($(this).parents()).data();
    $('#nombreServicioInhabilitarP').text(data.nombreServicio);
    $('#idServicioInhabilitar').val(data.idServicio);
  });
  // Modal Habilitar Proveedor con datos correspondientes
  $('#serviciosDataTable tbody').on("click", ".habilitar", function () {
    let data = dataTable.row($(this).parents()).data();
    $('#nombreServicioHabilitar').text(data.nombreServicio);
    $('#idServicioHabilitar').val(data.idServicio);
  });
  // Proceso de guardar servicio
  $("#btnGuardarServicio").click(function (e) {
    let nombreServicio = document.getElementById("nombreServicio");
    let codServicio = document.getElementById("codServicio");
    let precioServicio = document.getElementById("precioServicio");
    let proveedorServicio = document.getElementById("proveedorServicio");
    let categoriaServicio = document.getElementById("categoriaServicio");
    let formData = new FormData();
    formData.append("nombreServicio", (nombreServicio.value).toUpperCase());
    formData.append("codServicio", (codServicio.value).toUpperCase());
    formData.append("precioServicio", precioServicio.value);
    formData.append("proveedorServicio", proveedorServicio.value);
    formData.append("categoriaServicio", categoriaServicio.value);
    window.$.ajax({
      type: "post",
      url: "ServiciosController.php?method=guardarServicio",
      data: formData,
      cache: false,
      processData: false,
      contentType: false,
      beforeSend: function () {
        Swal.fire({
          allowOutsideClick: false,
          title: 'Cargando',
          timerProgressBar: true,
          didOpen: () => {
            Swal.showLoading()
            const b = Swal.getHtmlContainer().querySelector('b')
            timerInterval = setInterval(() => {
            }, 300)
          }
        })
      },
      success: function (response) {
        setTimeout(() => {
          Swal.close()
        }, 2000);
        let data = JSON.parse(response);
        if (data.estado == "ok") {
          nombreServicio.value = "";
          codServicio.value = "";
          precioServicio.value = "";
          proveedorServicio.value = "";
          categoriaServicio.value = "";
          $("#modalGuardarServicio").modal("hide");
          Swal.fire({
            text: data.mensaje,
            icon: 'success',
          })
          setTimeout(() => {
            Swal.close()
            dataTable.ajax.reload();
          }, 750);
        } else {
          $("#modalGuardarServicio").modal("hide");
          Swal.fire({
            text: data.mensaje,
            icon: 'error',
          })
          setTimeout(() => {
            Swal.close()
          }, 2000);
        }
      },
    });
  });
  // Proceso de editar servicio
  $('#btnEditarServicio').click(function (e) {
    let idServicio = document.getElementById("idServicio");
    let editNombreServicio = document.getElementById("editNombreServicio");
    let editCodServicio = document.getElementById("editCodServicio");
    let editPrecioServicio = document.getElementById("editPrecioServicio");
    let editProveedorServicio = document.getElementById("editProveedorServicio");
    let editCategoriaServicio = document.getElementById("editCategoriaServicio");
    let formData = new FormData;
    formData.append("idServicio", idServicio.value);
    formData.append("editNombreServicio", (editNombreServicio.value).toUpperCase());
    formData.append("editCodServicio", (editCodServicio.value).toUpperCase());
    formData.append("editPrecioServicio", editPrecioServicio.value);
    formData.append("editProveedorServicio", editProveedorServicio.value);
    formData.append("editCategoriaServicio", editCategoriaServicio.value);
    window.$.ajax({
      type: "post",
      url: "ServiciosController.php?method=editarServicio",
      data: formData,
      cache: false,
      processData: false,
      contentType: false,
      beforeSend: function () {
        Swal.fire({
          allowOutsideClick: false,
          title: 'Cargando',
          timerProgressBar: true,
          didOpen: () => {
            Swal.showLoading()
            const b = Swal.getHtmlContainer().querySelector('b')
            timerInterval = setInterval(() => {
            }, 300)
          }
        })
      },
      success: function (response) {
        setTimeout(() => {
          Swal.close()
        }, 2000);
        let data = JSON.parse(response);
        if (data.estado == 'ok') {
          $("#modalEditarServicio").modal("hide");
          Swal.fire({
            text: data.mensaje,
            icon: 'success',
          })
          setTimeout(() => {
            Swal.close()
            dataTable.ajax.reload();
          }, 1300);
        } else {
          $("#modalEditarProveedor").modal("hide");
          Swal.fire({
            text: data.mensaje,
            icon: 'error',
          })
          setTimeout(() => {
            Swal.close()
          }, 2000);
        }
      },
    });
  });
  // Proceso de inhabilitar servicio
  $('#btnInhabilitarServicio').click(function (e) {
    let dataTable = $("#serviciosDataTable").DataTable();
    let idServicio = document.getElementById("idServicioInhabilitar");
    let formData = new FormData;
    formData.append("idServicio", idServicio.value);
    window.$.ajax({
      type: "post",
      url: "ServiciosController.php?method=inhabilitarServicio",
      data: formData,
      cache: false,
      processData: false,
      contentType: false,
      beforeSend: function () {
        Swal.fire({
          allowOutsideClick: false,
          title: 'Cargando',
          timerProgressBar: true,
          didOpen: () => {
            Swal.showLoading()
            const b = Swal.getHtmlContainer().querySelector('b')
            timerInterval = setInterval(() => {
            }, 300)
          }
        })
      },
      success: function (response) {
        setTimeout(() => {
          Swal.close()
        }, 2000);
        let data = JSON.parse(response);
        if (data.estado == 'ok') {
          $("#modalInhabilitarServicio").modal("hide");
          Swal.fire({
            text: data.mensaje,
            icon: 'success',
          })
          setTimeout(() => {
            Swal.close()
            dataTable.ajax.reload();
          }, 1000);
        } else {
          $("#modalInhabilitarServicio").modal("hide");
          Swal.fire({
            text: data.mensaje,
            icon: 'error',
          })
          setTimeout(() => {
            Swal.close()
          }, 2000);
        }
      },
    });
  });
  // Proceso de inhabilitar servicio
  $('#btnHabilitarServicio').click(function (e) {
    let idServicio = document.getElementById("idServicioHabilitar");
    let formData = new FormData;
    formData.append("idServicio", idServicio.value);
    window.$.ajax({
      type: "post",
      url: "ServiciosController.php?method=habilitarServicio",
      data: formData,
      cache: false,
      processData: false,
      contentType: false,
      beforeSend: function () {
        Swal.fire({
          allowOutsideClick: false,
          title: 'Cargando',
          timerProgressBar: true,
          didOpen: () => {
            Swal.showLoading()
            const b = Swal.getHtmlContainer().querySelector('b')
            timerInterval = setInterval(() => {
            }, 300)
          }
        })
      },
      success: function (response) {
        setTimeout(() => {
          Swal.close()
        }, 2000);
        let data = JSON.parse(response);
        if (data.estado == 'ok') {
          $("#modalHabilitarServicio").modal("hide");
          Swal.fire({
            text: data.mensaje,
            icon: 'success',
          })
          setTimeout(() => {
            Swal.close()
            dataTable.ajax.reload();
          }, 1000);
        } else {
          $("#modalHabilitarServicio").modal("hide");
          Swal.fire({
            text: data.mensaje,
            icon: 'error',
          })
          setTimeout(() => {
            Swal.close()
          }, 2000);
        }
      },
    });
  });
});

// Limpiar inputs de modal de agregar
setInterval(() => {
  if (!($("#modalGuardarServicio").hasClass("show"))) {
    $("#nombreServicio").val('')
    $("#codServicio").val('')
    $("#precioServicio").val('')
    $("#proveedorServicio").val('0')
    $("#categoriaServicio").val('0')
  }
}, 500);

